{% extends "common/base.html" %}

{% block title %}MCP Studio - SAJHA MCP Server{% endblock %}

{% block extra_css %}
<style>
    .studio-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 600px;
    }
    
    .code-editor-panel {
        display: flex;
        flex-direction: column;
        background: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .panel-header {
        background: #2d2d2d;
        padding: 12px 15px;
        border-bottom: 1px solid #404040;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .panel-header h5 {
        margin: 0;
        color: #e0e0e0;
        font-size: 14px;
        font-weight: 600;
    }
    
    .code-textarea {
        flex: 1;
        width: 100%;
        border: none;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
        padding: 15px;
        resize: none;
        outline: none;
    }
    
    .code-textarea:focus {
        outline: none;
    }
    
    .output-panel {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .output-section {
        flex: 1;
        background: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .output-textarea {
        flex: 1;
        width: 100%;
        border: none;
        background: #1e1e1e;
        color: #9cdcfe;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
        padding: 10px;
        resize: none;
        outline: none;
    }
    
    .btn-delete-exists {
        background: #dc3545;
        border: 2px solid #ff6b6b;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        animation: pulse-danger 2s infinite;
    }
    
    .btn-delete-exists:hover {
        background: #c82333;
        border-color: #ff4757;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.7);
        color: white;
    }
    
    @keyframes pulse-danger {
        0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
        50% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.8); }
        100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
    }
    
    .delete-warning-icon {
        margin-right: 5px;
    }
    
    .tool-name-input {
        background: #2d2d2d;
        border: 1px solid #404040;
        color: #e0e0e0;
        padding: 8px 12px;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
    }
    
    .tool-name-input:focus {
        border-color: #007acc;
        outline: none;
    }
    
    .tool-name-input.is-valid {
        border-color: #28a745;
    }
    
    .tool-name-input.is-invalid {
        border-color: #dc3545;
    }
    
    .btn-studio {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-analyze {
        background: #007acc;
        border: none;
        color: white;
    }
    
    .btn-analyze:hover {
        background: #005a9e;
    }
    
    .btn-deploy {
        background: #28a745;
        border: none;
        color: white;
    }
    
    .btn-deploy:hover {
        background: #218838;
    }
    
    .btn-deploy:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .btn-clear {
        background: #6c757d;
        border: none;
        color: white;
    }
    
    .btn-clear:hover {
        background: #5a6268;
    }
    
    .status-bar {
        background: #007acc;
        color: white;
        padding: 6px 15px;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-bar.error {
        background: #dc3545;
    }
    
    .status-bar.success {
        background: #28a745;
    }
    
    .analysis-info {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .analysis-info h6 {
        color: #e0e0e0;
        margin-bottom: 10px;
    }
    
    .param-badge {
        display: inline-block;
        background: #404040;
        color: #9cdcfe;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin: 2px;
        font-family: monospace;
    }
    
    .param-badge.required {
        border-left: 3px solid #f14c4c;
    }
    
    .param-badge.optional {
        border-left: 3px solid #4ec9b0;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    
    .studio-intro {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        color: #e0e0e0;
    }
    
    .studio-intro h4 {
        color: #4ec9b0;
        margin-bottom: 10px;
    }
    
    .studio-intro code {
        background: #2d2d2d;
        padding: 2px 6px;
        border-radius: 3px;
        color: #ce9178;
    }
    
    .file-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-family: monospace;
    }
    
    .file-badge.json {
        background: #c6a827;
        color: #1e1e1e;
    }
    
    .file-badge.python {
        background: #3572a5;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Header with Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb small">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('admin_tools') }}">Tools Management</a></li>
            <li class="breadcrumb-item active">MCP Studio</li>
        </ol>
    </nav>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1">
                <i class="bi bi-magic me-2"></i>MCP Studio
                <span class="badge bg-gradient text-white ms-2" style="font-size: 0.6rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">v{{ app_version }}</span>
            </h4>
            <small class="text-muted">Enterprise Visual Tool Creation Platform</small>
        </div>
        <div>
            <a href="{{ url_for('studio_examples') }}" class="btn btn-outline-info btn-sm me-2">
                <i class="bi bi-book me-1"></i>Examples
            </a>
            <a href="{{ url_for('help_page') }}#mcp-studio" class="btn btn-outline-warning btn-sm me-2">
                <i class="bi bi-question-circle me-1"></i>Help
            </a>
            <a href="{{ url_for('admin_tools') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Back to Tools
            </a>
        </div>
    </div>
    
    <!-- MCP Studio Overview Banner -->
    <div class="alert alert-info d-flex align-items-center mb-4" role="alert" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: none;">
        <i class="bi bi-lightbulb-fill me-3 fs-4 text-info"></i>
        <div>
            <strong>MCP Studio</strong> enables you to create MCP-compliant tools in three ways: 
            write Python code with our decorator, wrap any REST API endpoint, or create database query tools. 
            All methods generate production-ready tools that are immediately available to AI clients.
        </div>
    </div>
    
    <!-- Tool Creation Methods - Enhanced Cards -->
    <div class="row mb-4">
        <!-- Python Code Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 border-primary shadow-sm tool-method-card" style="border-width: 2px;">
                <div class="card-header bg-primary text-white d-flex align-items-center">
                    <i class="bi bi-code-slash fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">Python Code Tool</h5>
                        <small class="opacity-75">@sajhamcptool decorator</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Write Python functions with our decorator. The system uses AST analysis to 
                        automatically generate tool configuration and implementation.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Type hints â†’ JSON Schema</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Docstrings â†’ Descriptions</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Full control over logic</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Hot-reload enabled</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <span class="badge bg-primary w-100 py-2">
                        <i class="bi bi-arrow-down me-1"></i>Currently Active Below
                    </span>
                </div>
            </div>
        </div>
        
        <!-- REST Service Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 border-success shadow-sm tool-method-card">
                <div class="card-header bg-success text-white d-flex align-items-center">
                    <i class="bi bi-cloud-arrow-up fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">REST Service Tool</h5>
                        <small class="opacity-75">Wrap any REST API</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Transform any REST API endpoint into an MCP tool. Define the endpoint,
                        authentication, and schemas through a visual form.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>GET, POST, PUT, DELETE, PATCH</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>API Key &amp; Basic Auth</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Custom headers &amp; timeout</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Path parameter support</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_rest') }}" class="btn btn-success w-100">
                        <i class="bi bi-arrow-right me-1"></i>Open REST Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- DB Query Tool Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 border-warning shadow-sm tool-method-card">
                <div class="card-header bg-warning text-dark d-flex align-items-center">
                    <i class="bi bi-database fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">Database Query Tool</h5>
                        <small class="opacity-75">SQL-based MCP tools</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Create MCP tools that execute SQL queries against databases. 
                        Define parameters, query templates, and connection details.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>DuckDB, SQLite, PostgreSQL, MySQL</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Parameterized queries</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Auto-generated schemas</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Tool literature support</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_dbquery') }}" class="btn btn-warning w-100 text-dark">
                        <i class="bi bi-arrow-right me-1"></i>Open DB Query Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Script Tool Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 border-danger shadow-sm tool-method-card">
                <div class="card-header bg-danger text-white d-flex align-items-center">
                    <i class="bi bi-terminal fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">Script Tool</h5>
                        <small class="opacity-75">Shell & Python scripts</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Create MCP tools from shell scripts, Python scripts, or other executables.
                        Pass arguments and capture STDOUT/STDERR output.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Bash, Shell, Python, Node.js, Perl, Ruby</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>File upload or paste code</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Configurable timeout & env vars</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Auto-detects script type</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_script') }}" class="btn btn-danger w-100">
                        <i class="bi bi-arrow-right me-1"></i>Open Script Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- PowerBI Report Tool Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 shadow-sm tool-method-card" style="border: 2px solid #f2c811;">
                <div class="card-header d-flex align-items-center" style="background: linear-gradient(135deg, #f2c811 0%, #e6b800 100%); color: #212529;">
                    <i class="bi bi-bar-chart-fill fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">PowerBI Report</h5>
                        <small class="opacity-75">PDF/PPTX/PNG export</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Create MCP tools that retrieve PowerBI reports as PDF, PPTX, or PNG 
                        in base64 encoded format.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Export to PDF, PPTX, or PNG</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Azure AD authentication</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Base64 encoded output</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Optional page selection</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_powerbi') }}" class="btn w-100" style="background: #f2c811; color: #212529; font-weight: 600;">
                        <i class="bi bi-arrow-right me-1"></i>Open PowerBI Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- PowerBI DAX Query Tool Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 shadow-sm tool-method-card" style="border: 2px solid #00d4aa;">
                <div class="card-header d-flex align-items-center" style="background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%); color: #212529;">
                    <i class="bi bi-braces fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">PowerBI DAX</h5>
                        <small class="opacity-75">DAX query execution</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Create MCP tools that execute DAX queries against PowerBI datasets
                        and return structured JSON results.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Execute DAX queries</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Parameterized queries</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>JSON result format</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Azure AD authentication</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_powerbidax') }}" class="btn w-100" style="background: #00d4aa; color: #212529; font-weight: 600;">
                        <i class="bi bi-arrow-right me-1"></i>Open DAX Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- IBM LiveLink Document Tool Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 shadow-sm tool-method-card" style="border: 2px solid #0077b6;">
                <div class="card-header d-flex align-items-center" style="background: linear-gradient(135deg, #0077b6 0%, #023e8a 100%); color: white;">
                    <i class="bi bi-folder2-open fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">IBM LiveLink</h5>
                        <small class="opacity-75">Document retrieval</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Create MCP tools to query and download documents from IBM LiveLink
                        (OpenText Content Server) as base64.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Search & list documents</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Download as base64</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Basic, OAuth, OTDS auth</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>REST API v1 & v2</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_livelink') }}" class="btn w-100" style="background: #0077b6; color: white; font-weight: 600;">
                        <i class="bi bi-arrow-right me-1"></i>Open LiveLink Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Microsoft SharePoint Tool Creator Card -->
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card h-100 shadow-sm tool-method-card" style="border: 2px solid #0078d4;">
                <div class="card-header d-flex align-items-center" style="background: linear-gradient(135deg, #0078d4 0%, #004578 100%); color: white;">
                    <i class="bi bi-microsoft fs-4 me-2"></i>
                    <div>
                        <h5 class="mb-0">SharePoint</h5>
                        <small class="opacity-75">Microsoft 365</small>
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        Create MCP tools to interact with Microsoft SharePoint - documents,
                        lists, sites, and enterprise search.
                    </p>
                    <div class="feature-list mb-3">
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Document management (upload, download, versioning)</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>List operations (CRUD, queries)</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Site administration and users</small>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Enterprise search across content</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_sharepoint') }}" class="btn w-100" style="background: #0078d4; color: white; font-weight: 600;">
                        <i class="bi bi-arrow-right me-1"></i>Open SharePoint Creator
                    </a>
                </div>
            </div>
        </div>
        
        <!-- OLAP Dataset Creator Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow-sm tool-card" style="border-left: 4px solid #4ecdc4 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="mb-0">OLAP Analytics</h5>
                            <small class="opacity-75">Advanced Analytics</small>
                        </div>
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);">
                            <i class="bi bi-graph-up-arrow text-white fs-5"></i>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">
                        Create semantic datasets for advanced OLAP analytics including pivot tables,
                        rollups, time series analysis, and statistical calculations.
                    </p>
                    <div class="d-flex flex-column gap-2 small mb-3">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Pivot Tables & Cross-tabs</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Time Series & Period Comparisons</small>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                            <small>Window Functions & Statistics</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-0 pb-3">
                    <a href="{{ url_for('studio_olap') }}" class="btn w-100" style="background: #4ecdc4; color: white; font-weight: 600;">
                        <i class="bi bi-arrow-right me-1"></i>Open OLAP Creator
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Coming Soon Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-secondary d-flex align-items-center" role="alert">
                <i class="bi bi-lightbulb me-3 fs-4"></i>
                <div>
                    <strong>Coming Soon:</strong> GraphQL API Wrapper, OpenAPI/Swagger Import, CLI Command Wrapper
                </div>
            </div>
        </div>
    </div>
    
    <!-- Separator -->
    <hr class="my-4">
    <h5 class="mb-3 text-muted"><i class="bi bi-code-slash me-2"></i>Python Code Tool Creator</h5>
    
    <!-- Introduction -->
    <div class="studio-intro">
        <h4><i class="bi bi-stars me-2"></i>Python Code Tool Creator</h4>
        <p class="mb-2">
            Create MCP tools by writing Python functions with the <code>@sajhamcptool</code> decorator.
            The system automatically generates the tool configuration and implementation files.
        </p>
        <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Your function's type hints define the input/output schemas. Required parameters have no default values.
        </small>
    </div>
    
    <!-- Tool Name Input -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label text-light small">Tool Name</label>
            <div class="d-flex gap-2">
                <input type="text" id="toolName" class="form-control tool-name-input flex-grow-1" 
                       placeholder="my_custom_tool" pattern="[a-z][a-z0-9_]*">
                <button id="deleteExistsBtn" class="btn btn-delete-exists" onclick="deleteIfExists()" title="Delete existing tool files">
                    <i class="bi bi-trash delete-warning-icon"></i>Delete if Exists
                </button>
            </div>
            <div id="toolNameFeedback" class="invalid-feedback"></div>
            <small class="text-muted">Lowercase letters, numbers, and underscores only</small>
        </div>
        <div class="col-md-8 d-flex align-items-end gap-2">
            <button id="analyzeBtn" class="btn btn-studio btn-analyze" onclick="analyzeCode()">
                <i class="bi bi-search me-1"></i>Analyze Code
            </button>
            <button id="deployBtn" class="btn btn-studio btn-deploy" onclick="deployTool()" disabled>
                <i class="bi bi-cloud-upload me-1"></i>Deploy Tool
            </button>
            <button class="btn btn-studio btn-clear" onclick="clearAll()">
                <i class="bi bi-x-circle me-1"></i>Clear
            </button>
        </div>
    </div>
    
    <!-- Analysis Info (hidden initially) -->
    <div id="analysisInfo" class="analysis-info" style="display: none;">
        <h6><i class="bi bi-info-circle me-2"></i>Analysis Result</h6>
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">Description:</small>
                <p id="toolDescription" class="mb-2 text-light"></p>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Category:</small>
                <p id="toolCategory" class="mb-2 text-light"></p>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Function:</small>
                <p id="toolFunction" class="mb-2 text-light font-monospace"></p>
            </div>
        </div>
        <div>
            <small class="text-muted">Parameters:</small>
            <div id="toolParams" class="mt-1"></div>
        </div>
    </div>
    
    <!-- Main Studio Layout -->
    <div class="studio-container">
        <!-- Left Panel: Code Editor -->
        <div class="code-editor-panel">
            <div class="panel-header">
                <h5><i class="bi bi-code-slash me-2"></i>Python Code</h5>
                <span class="badge bg-secondary">Input</span>
            </div>
            <textarea id="codeEditor" class="code-textarea" 
                      placeholder="Paste or type your @sajhamcptool decorated Python function here...">{{ sample_code }}</textarea>
            <div id="codeStatus" class="status-bar">
                Ready - Enter your code and click "Analyze Code"
            </div>
        </div>
        
        <!-- Right Panel: Generated Output -->
        <div class="output-panel">
            <!-- JSON Config -->
            <div class="output-section">
                <div class="panel-header">
                    <h5>
                        <i class="bi bi-filetype-json me-2"></i>Tool Configuration
                        <span id="jsonFilename" class="file-badge json ms-2" style="display: none;"></span>
                    </h5>
                    <span class="badge bg-info">JSON</span>
                </div>
                <textarea id="jsonOutput" class="output-textarea" readonly 
                          placeholder="Generated JSON configuration will appear here..."></textarea>
            </div>
            
            <!-- Python Implementation -->
            <div class="output-section">
                <div class="panel-header">
                    <h5>
                        <i class="bi bi-filetype-py me-2"></i>Tool Implementation
                        <span id="pythonFilename" class="file-badge python ms-2" style="display: none;"></span>
                    </h5>
                    <span class="badge bg-success">Python</span>
                </div>
                <textarea id="pythonOutput" class="output-textarea" readonly 
                          placeholder="Generated Python implementation will appear here..."></textarea>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success">
                <h5 class="modal-title text-success">
                    <i class="bi bi-check-circle me-2"></i>Tool Deployed Successfully!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-light">Your tool has been created and deployed.</p>
                <div class="bg-secondary bg-opacity-25 p-3 rounded">
                    <p class="mb-2"><strong>Tool Name:</strong> <code id="deployedToolName"></code></p>
                    <p class="mb-2"><strong>JSON Config:</strong> <code id="deployedJsonPath"></code></p>
                    <p class="mb-0"><strong>Python File:</strong> <code id="deployedPythonPath"></code></p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('admin_tools') }}" class="btn btn-primary">
                    <i class="bi bi-tools me-1"></i>View Tools
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_glossary %}
<div class="container-fluid mt-4">
    <div class="card border-secondary">
        <div class="card-header bg-secondary text-white" data-bs-toggle="collapse" data-bs-target="#pageGlossary" style="cursor: pointer;">
            <i class="bi bi-book me-2"></i>Page Glossary
            <i class="bi bi-chevron-down float-end"></i>
        </div>
        <div class="collapse" id="pageGlossary">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>MCP Studio:</strong> Visual interface for creating MCP tools without manual coding.</p>
                        <p><strong>@sajhamcptool Decorator:</strong> Python decorator that marks a function as an MCP tool.</p>
                        <p><strong>AST (Abstract Syntax Tree):</strong> Code representation used to analyze Python functions.</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Type Hints:</strong> Python annotations indicating expected data types for auto-schema generation.</p>
                        <p><strong>Code Generation:</strong> Automatic production of tool class and JSON configuration.</p>
                        <p><strong>Input Schema:</strong> JSON Schema definition generated from function parameters.</p>
                    </div>
                </div>
                <div class="text-end mt-2">
                    <a href="{{ url_for('docs_view', doc_path='architecture/Glossary.md') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-book me-1"></i>View Full Glossary
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let analysisComplete = false;
let existingTools = {{ existing_tools | tojson }};

// Validate tool name on input
document.getElementById('toolName').addEventListener('input', function() {
    validateToolName(this.value);
});

function validateToolName(name) {
    const input = document.getElementById('toolName');
    const feedback = document.getElementById('toolNameFeedback');
    
    if (!name) {
        input.classList.remove('is-valid', 'is-invalid');
        return false;
    }
    
    // Client-side validation
    if (!/^[a-z][a-z0-9_]*$/.test(name)) {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        feedback.textContent = 'Must start with lowercase letter, use only a-z, 0-9, _';
        return false;
    }
    
    if (name.length < 3) {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        feedback.textContent = 'Must be at least 3 characters';
        return false;
    }
    
    if (existingTools.includes(name)) {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        feedback.textContent = 'Tool name already exists';
        return false;
    }
    
    input.classList.remove('is-invalid');
    input.classList.add('is-valid');
    return true;
}

async function analyzeCode() {
    const code = document.getElementById('codeEditor').value;
    const toolName = document.getElementById('toolName').value.trim().toLowerCase();
    const statusBar = document.getElementById('codeStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const deployBtn = document.getElementById('deployBtn');
    
    if (!toolName || !validateToolName(toolName)) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = 'Please enter a valid tool name';
        return;
    }
    
    if (!code.trim()) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = 'Please enter some code';
        return;
    }
    
    // Show loading
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';
    statusBar.className = 'status-bar';
    statusBar.textContent = 'Analyzing code...';
    
    try {
        const response = await fetch('/admin/studio/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code: code, tool_name: toolName})
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update outputs
            document.getElementById('jsonOutput').value = data.json_content;
            document.getElementById('pythonOutput').value = data.python_content;
            
            // Show filenames
            document.getElementById('jsonFilename').textContent = data.json_filename;
            document.getElementById('jsonFilename').style.display = 'inline-block';
            document.getElementById('pythonFilename').textContent = data.python_filename;
            document.getElementById('pythonFilename').style.display = 'inline-block';
            
            // Update analysis info
            document.getElementById('toolDescription').textContent = data.description;
            document.getElementById('toolCategory').textContent = data.category;
            document.getElementById('toolFunction').textContent = data.function_name + '()';
            
            // Show parameters
            const paramsDiv = document.getElementById('toolParams');
            paramsDiv.innerHTML = data.parameters.map(p => 
                `<span class="param-badge ${p.required ? 'required' : 'optional'}">
                    ${p.name}: ${p.type}${p.default !== null ? ' = ' + JSON.stringify(p.default) : ''}
                </span>`
            ).join('');
            
            document.getElementById('analysisInfo').style.display = 'block';
            
            // Enable deploy
            deployBtn.disabled = false;
            analysisComplete = true;
            
            statusBar.className = 'status-bar success';
            statusBar.textContent = `Analysis complete - Found function "${data.function_name}" with ${data.parameters.length} parameters`;
            
            if (data.warnings && data.warnings.length > 0) {
                statusBar.textContent += ' (with warnings)';
            }
        } else {
            throw new Error(data.error || 'Analysis failed');
        }
    } catch (error) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = error.message;
        deployBtn.disabled = true;
        analysisComplete = false;
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="bi bi-search me-1"></i>Analyze Code';
    }
}

async function deployTool() {
    if (!analysisComplete) {
        alert('Please analyze the code first');
        return;
    }
    
    const code = document.getElementById('codeEditor').value;
    const toolName = document.getElementById('toolName').value.trim().toLowerCase();
    const deployBtn = document.getElementById('deployBtn');
    const statusBar = document.getElementById('codeStatus');
    
    if (!confirm(`Are you sure you want to deploy the tool "${toolName}"?\n\nThis will create new files in your server.`)) {
        return;
    }
    
    deployBtn.disabled = true;
    deployBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Deploying...';
    statusBar.textContent = 'Deploying tool...';
    
    try {
        const response = await fetch('/admin/studio/deploy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code: code, tool_name: toolName})
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update existing tools list
            existingTools.push(toolName);
            
            // Show success modal
            document.getElementById('deployedToolName').textContent = data.tool_name;
            document.getElementById('deployedJsonPath').textContent = data.json_path;
            document.getElementById('deployedPythonPath').textContent = data.python_path;
            
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            
            statusBar.className = 'status-bar success';
            statusBar.textContent = `Tool "${toolName}" deployed successfully!`;
            
            // Reset form
            analysisComplete = false;
            deployBtn.disabled = true;
        } else {
            throw new Error(data.error || 'Deployment failed');
        }
    } catch (error) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = error.message;
    } finally {
        deployBtn.innerHTML = '<i class="bi bi-cloud-upload me-1"></i>Deploy Tool';
    }
}

async function deleteIfExists() {
    const toolName = document.getElementById('toolName').value.trim().toLowerCase();
    const statusBar = document.getElementById('codeStatus');
    const deleteBtn = document.getElementById('deleteExistsBtn');
    
    if (!toolName) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = 'Please enter a tool name first';
        return;
    }
    
    // Basic format validation
    if (!/^[a-z][a-z0-9_]*$/.test(toolName) || toolName.length < 3) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = 'Invalid tool name format';
        return;
    }
    
    // Double confirmation for safety
    const confirmed = confirm(
        `âš ï¸ WARNING: This will DELETE the following files if they exist:\n\n` +
        `â€¢ config/tools/${toolName}.json\n` +
        `â€¢ sajha/tools/impl/studio_${toolName}.py\n\n` +
        `This action CANNOT be undone!\n\n` +
        `Are you sure you want to proceed?`
    );
    
    if (!confirmed) {
        return;
    }
    
    // Second confirmation
    const doubleConfirmed = confirm(
        `ðŸš¨ FINAL CONFIRMATION ðŸš¨\n\n` +
        `You are about to permanently delete tool "${toolName}".\n\n` +
        `Click OK to DELETE, or Cancel to abort.`
    );
    
    if (!doubleConfirmed) {
        return;
    }
    
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Deleting...';
    statusBar.className = 'status-bar';
    statusBar.textContent = 'Deleting tool files...';
    
    try {
        const response = await fetch('/admin/studio/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tool_name: toolName})
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from existing tools list if present
            const index = existingTools.indexOf(toolName);
            if (index > -1) {
                existingTools.splice(index, 1);
            }
            
            // Reset validation state
            const input = document.getElementById('toolName');
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            
            statusBar.className = 'status-bar success';
            statusBar.textContent = data.message;
            
            // Clear outputs if they were showing the deleted tool
            document.getElementById('jsonOutput').value = '';
            document.getElementById('pythonOutput').value = '';
            document.getElementById('jsonFilename').style.display = 'none';
            document.getElementById('pythonFilename').style.display = 'none';
            document.getElementById('analysisInfo').style.display = 'none';
            document.getElementById('deployBtn').disabled = true;
            analysisComplete = false;
        } else {
            throw new Error(data.error || 'Deletion failed');
        }
    } catch (error) {
        statusBar.className = 'status-bar error';
        statusBar.textContent = error.message;
    } finally {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="bi bi-trash delete-warning-icon"></i>Delete if Exists';
    }
}

function clearAll() {
    document.getElementById('codeEditor').value = '';
    document.getElementById('toolName').value = '';
    document.getElementById('toolName').classList.remove('is-valid', 'is-invalid');
    document.getElementById('jsonOutput').value = '';
    document.getElementById('pythonOutput').value = '';
    document.getElementById('jsonFilename').style.display = 'none';
    document.getElementById('pythonFilename').style.display = 'none';
    document.getElementById('analysisInfo').style.display = 'none';
    document.getElementById('deployBtn').disabled = true;
    document.getElementById('codeStatus').className = 'status-bar';
    document.getElementById('codeStatus').textContent = 'Ready - Enter your code and click "Analyze Code"';
    analysisComplete = false;
}
</script>
{% endblock %}
