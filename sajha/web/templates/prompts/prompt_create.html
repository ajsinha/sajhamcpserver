{% extends "common/base.html" %}
<!--
Copyright All rights Reserved 2025-2030, Ashutosh Sinha, Email: ajsinha@gmail.com
-->
{% block title %}Create New Prompt - SAJHA MCP Server{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('prompts_list') }}">Prompts</a></li>
            <li class="breadcrumb-item active">Create New</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-plus-circle"></i> Create New Prompt
        </h1>
        <a href="{{ url_for('prompts_list') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Prompts
        </a>
    </div>

    <!-- Mode Toggle -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="createMode" id="formMode" checked autocomplete="off" onclick="switchMode('form')">
                <label class="btn btn-outline-primary" for="formMode">
                    <i class="bi bi-ui-checks"></i> Form Mode
                </label>

                <input type="radio" class="btn-check" name="createMode" id="jsonMode" autocomplete="off" onclick="switchMode('json')">
                <label class="btn btn-outline-primary" for="jsonMode">
                    <i class="bi bi-code-square"></i> JSON Mode
                </label>
            </div>
        </div>
    </div>

    <!-- Form Mode -->
    <div id="formModeContainer">
        <form id="promptForm">
            <div class="row">
                <div class="col-md-8">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="promptName" class="form-label">
                                    Prompt Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="promptName" required
                                       placeholder="e.g., code_review, data_analysis"
                                       pattern="[a-z0-9_]+"
                                       title="Only lowercase letters, numbers, and underscores allowed">
                                <small class="form-text text-muted">Use only lowercase letters, numbers, and underscores</small>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    Description <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="description" rows="3" required
                                          placeholder="Brief description of what this prompt does..."></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="category" 
                                           placeholder="e.g., development, analysis, business"
                                           list="categoryList">
                                    <datalist id="categoryList">
                                        <option value="development">
                                        <option value="analysis">
                                        <option value="business">
                                        <option value="marketing">
                                        <option value="general">
                                    </datalist>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="author" class="form-label">Author</label>
                                    <input type="text" class="form-control" id="author" 
                                           value="{{ user.user_name }}" readonly>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="tags" class="form-label">Tags</label>
                                <input type="text" class="form-control" id="tags" 
                                       placeholder="Enter tags separated by commas">
                                <small class="form-text text-muted">E.g., code, review, python, analysis</small>
                            </div>
                        </div>
                    </div>

                    <!-- Prompt Template -->
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-file-text"></i> Prompt Template</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-lightbulb"></i> Use <code>{variable_name}</code> to define placeholders for arguments.
                            </div>
                            <textarea class="form-control font-monospace" id="promptTemplate" rows="15" required
                                      placeholder="Enter your prompt template here...

Example:
Please review the following {language} code:

{code}

Provide feedback on:
1. Code quality
2. Best practices
3. Potential improvements"></textarea>
                        </div>
                    </div>

                    <!-- Arguments -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-list-check"></i> Arguments</h5>
                            <button type="button" class="btn btn-sm btn-light" onclick="addArgument()">
                                <i class="bi bi-plus"></i> Add Argument
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="argumentsList">
                                <p class="text-muted">No arguments defined yet. Click "Add Argument" to add one.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-md-4">
                    <!-- Actions -->
                    <div class="card mb-4 sticky-top" style="top: 20px;">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0"><i class="bi bi-lightning"></i> Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-save"></i> Create Prompt
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="previewPrompt()">
                                    <i class="bi bi-eye"></i> Preview JSON
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Reset Form
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tips -->
                    <div class="card">
                        <div class="card-header bg-warning">
                            <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h6>
                        </div>
                        <div class="card-body">
                            <ul class="small mb-0">
                                <li>Use descriptive prompt names</li>
                                <li>Define clear argument descriptions</li>
                                <li>Mark required arguments appropriately</li>
                                <li>Use categories to organize prompts</li>
                                <li>Add relevant tags for searchability</li>
                                <li>Test your prompt after creation</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- JSON Mode -->
    <div id="jsonModeContainer" style="display: none;">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-code-square"></i> JSON Editor</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Paste or write your prompt configuration in JSON format below.
                </div>
                <textarea class="form-control font-monospace" id="jsonEditor" rows="25"
                          placeholder='{
  "name": "your_prompt_name",
  "description": "Description of your prompt",
  "prompt_template": "Your template with {variables}",
  "arguments": [
    {
      "name": "variable_name",
      "description": "Description",
      "required": true
    }
  ],
  "metadata": {
    "category": "general",
    "tags": ["tag1", "tag2"],
    "author": "{{ user.user_name }}",
    "version": "1.0"
  }
}'></textarea>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="createFromJson()">
                        <i class="bi bi-save"></i> Create from JSON
                    </button>
                    <button class="btn btn-info" onclick="validateJsonInput()">
                        <i class="bi bi-check-circle"></i> Validate JSON
                    </button>
                    <button class="btn btn-secondary" onclick="loadTemplate()">
                        <i class="bi bi-file-earmark"></i> Load Template
                    </button>
                </div>
                <div id="jsonValidationResult" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-eye"></i> Prompt Preview (JSON)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="previewJson" class="bg-dark text-light p-3 rounded" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyPreview()">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block page_glossary %}
<div class="container-fluid mt-4">
    <div class="card border-secondary">
        <div class="card-header bg-secondary text-white" data-bs-toggle="collapse" data-bs-target="#pageGlossary" style="cursor: pointer;">
            <i class="bi bi-book me-2"></i>Page Glossary
            <i class="bi bi-chevron-down float-end"></i>
        </div>
        <div class="collapse" id="pageGlossary">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Prompt Template:</strong> A reusable text with variable placeholders for AI instructions.</p>
                        <p><strong>Variable Substitution:</strong> Replacing {{variable}} placeholders with actual values.</p>
                        <p><strong>Arguments:</strong> The parameters/variables that can be passed to a prompt.</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Category:</strong> A grouping for organizing related prompts.</p>
                        <p><strong>Description:</strong> Human-readable explanation of the prompt's purpose.</p>
                        <p><strong>Jinja2:</strong> Template engine supporting advanced variable substitution.</p>
                    </div>
                </div>
                <div class="text-end mt-2">
                    <a href="{{ url_for('docs_view', doc_path='architecture/Glossary.md') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-book me-1"></i>View Full Glossary
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let argumentCount = 0;
let currentMode = 'form';

// Form submission
document.getElementById('promptForm').addEventListener('submit', function(e) {
    e.preventDefault();
    createPrompt();
});

function switchMode(mode) {
    currentMode = mode;
    if (mode === 'form') {
        document.getElementById('formModeContainer').style.display = 'block';
        document.getElementById('jsonModeContainer').style.display = 'none';
    } else {
        document.getElementById('formModeContainer').style.display = 'none';
        document.getElementById('jsonModeContainer').style.display = 'block';
    }
}

function addArgument() {
    argumentCount++;
    const container = document.getElementById('argumentsList');
    
    if (container.querySelector('p')) {
        container.innerHTML = '';
    }
    
    const argDiv = document.createElement('div');
    argDiv.className = 'card mb-3';
    argDiv.id = `argument_${argumentCount}`;
    argDiv.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <h6 class="mb-0">Argument #${argumentCount}</h6>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeArgument(${argumentCount})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm arg-name" 
                       placeholder="Argument name (e.g., code, language)" required>
            </div>
            <div class="mb-2">
                <textarea class="form-control form-control-sm arg-description" rows="2"
                          placeholder="Description (optional)"></textarea>
            </div>
            <div class="form-check">
                <input class="form-check-input arg-required" type="checkbox" id="required_${argumentCount}">
                <label class="form-check-label" for="required_${argumentCount}">
                    Required argument
                </label>
            </div>
        </div>
    `;
    container.appendChild(argDiv);
}

function removeArgument(id) {
    document.getElementById(`argument_${id}`).remove();
    const container = document.getElementById('argumentsList');
    if (container.children.length === 0) {
        container.innerHTML = '<p class="text-muted">No arguments defined yet. Click "Add Argument" to add one.</p>';
    }
}

function collectFormData() {
    const tags = document.getElementById('tags').value
        .split(',')
        .map(t => t.trim())
        .filter(t => t.length > 0);
    
    const arguments = [];
    document.querySelectorAll('#argumentsList .card').forEach(card => {
        const name = card.querySelector('.arg-name').value.trim();
        if (name) {
            arguments.push({
                name: name,
                description: card.querySelector('.arg-description').value.trim(),
                required: card.querySelector('.arg-required').checked
            });
        }
    });
    
    return {
        name: document.getElementById('promptName').value.trim(),
        description: document.getElementById('description').value.trim(),
        prompt_template: document.getElementById('promptTemplate').value,
        arguments: arguments,
        metadata: {
            category: document.getElementById('category').value.trim() || 'general',
            tags: tags,
            author: document.getElementById('author').value.trim(),
            version: '1.0'
        }
    };
}

function previewPrompt() {
    const data = collectFormData();
    document.getElementById('previewJson').textContent = JSON.stringify(data, null, 2);
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function copyPreview() {
    const text = document.getElementById('previewJson').textContent;
    navigator.clipboard.writeText(text).then(() => alert('JSON copied!'));
}

function createPrompt() {
    const data = collectFormData();
    
    if (!data.name || !data.description || !data.prompt_template) {
        alert('Please fill in all required fields');
        return;
    }
    
    $.ajax({
        url: '/api/prompts/create',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                alert('Prompt created successfully!');
                window.location.href = `/prompts/${data.name}`;
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function(xhr) {
            alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
        }
    });
}

function createFromJson() {
    const jsonText = document.getElementById('jsonEditor').value;
    
    try {
        const data = JSON.parse(jsonText);
        
        $.ajax({
            url: '/api/prompts/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    alert('Prompt created successfully!');
                    window.location.href = `/prompts/${data.name}`;
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
            }
        });
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

function validateJsonInput() {
    const jsonText = document.getElementById('jsonEditor').value;
    const result = document.getElementById('jsonValidationResult');
    
    try {
        JSON.parse(jsonText);
        result.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> JSON is valid!</div>';
    } catch (e) {
        result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Invalid JSON: ${e.message}</div>`;
    }
}

function loadTemplate() {
    const template = {
        name: "example_prompt",
        description: "Example prompt template",
        prompt_template: "Your prompt template with {variable1} and {variable2}",
        arguments: [
            {
                name: "variable1",
                description: "Description of variable1",
                required: true
            },
            {
                name: "variable2",
                description: "Description of variable2",
                required: false
            }
        ],
        metadata: {
            category: "general",
            tags: ["example", "template"],
            author: "{{ user.user_name }}",
            version: "1.0"
        }
    };
    
    document.getElementById('jsonEditor').value = JSON.stringify(template, null, 2);
}

function resetForm() {
    if (confirm('Are you sure you want to reset the form?')) {
        document.getElementById('promptForm').reset();
        document.getElementById('argumentsList').innerHTML = '<p class="text-muted">No arguments defined yet. Click "Add Argument" to add one.</p>';
        argumentCount = 0;
    }
}
</script>
{% endblock %}
