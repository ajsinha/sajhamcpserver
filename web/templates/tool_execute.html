{% extends "base.html" %}
<!--
Copyright All rights Reserved 2025-2030, Ashutosh Sinha, Email: ajsinha@gmail.com
-->
{% block title %}Execute Tool: {{ tool.name }} - SAJHA MCP Server{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <h1 class="h3 mb-4">
                <i class="bi bi-play-circle"></i> Execute Tool: {{ tool.name }}
            </h1>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('tools_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Tools
            </a>
        </div>
    </div>
    
    <!-- Tool Information -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Tool Information</h5>
        </div>
        <div class="card-body">
            <p><strong>Name:</strong> {{ tool.name }}</p>
            <p><strong>Description:</strong> {{ tool.description }}</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Input Parameters -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-input-cursor"></i> Input Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="toolExecuteForm">
                        <div id="dynamicInputs"></div>
                        
                        <div class="d-grid gap-2 mt-3">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-play-fill"></i> Execute Tool
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Input Schema -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-code-square"></i> Input Schema</h6>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-2"><code>{{ tool.inputSchema|tojson(indent=2) }}</code></pre>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-terminal"></i> Execution Results</h5>
                </div>
                <div class="card-body">
                    <div id="results" style="min-height: 300px;">
                        <div class="text-muted text-center">
                            <i class="bi bi-info-circle"></i> Results will appear here after execution
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Execution History -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent Executions</h6>
                </div>
                <div class="card-body">
                    <div id="executionHistory" class="list-group">
                        <div class="text-muted text-center">
                            <small>No recent executions</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const toolName = "{{ tool.name }}";
const toolSchema = {{ tool.inputSchema|tojson }};
let executionHistory = [];

// Generate form inputs based on schema
function generateFormInputs() {
    const container = document.getElementById('dynamicInputs');
    container.innerHTML = '';
    
    if (toolSchema.properties) {
        Object.keys(toolSchema.properties).forEach(key => {
            const property = toolSchema.properties[key];
            const isRequired = toolSchema.required && toolSchema.required.includes(key);
            
            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            
            let inputHtml = '';
            
            // Create label
            inputHtml += `<label for="${key}" class="form-label">
                ${key} ${isRequired ? '<span class="text-danger">*</span>' : ''}
                ${property.description ? `<small class="text-muted">(${property.description})</small>` : ''}
            </label>`;
            
            // Create input based on type
            if (property.enum) {
                // Dropdown for enum
                inputHtml += `<select class="form-control" id="${key}" name="${key}" ${isRequired ? 'required' : ''}>`;
                inputHtml += `<option value="">-- Select --</option>`;
                property.enum.forEach(value => {
                    const selected = property.default === value ? 'selected' : '';
                    inputHtml += `<option value="${value}" ${selected}>${value}</option>`;
                });
                inputHtml += `</select>`;
            } else if (property.type === 'boolean') {
                // Checkbox for boolean
                inputHtml += `<div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${key}" name="${key}" 
                           ${property.default ? 'checked' : ''}>
                    <label class="form-check-label" for="${key}">Enable</label>
                </div>`;
            } else if (property.type === 'integer' || property.type === 'number') {
                // Number input
                inputHtml += `<input type="number" class="form-control" id="${key}" name="${key}" 
                    ${isRequired ? 'required' : ''} 
                    ${property.minimum !== undefined ? `min="${property.minimum}"` : ''} 
                    ${property.maximum !== undefined ? `max="${property.maximum}"` : ''}
                    ${property.default !== undefined ? `value="${property.default}"` : ''}>`;
            } else if (property.type === 'object') {
                // JSON textarea for object
                inputHtml += `<textarea class="form-control" id="${key}" name="${key}" rows="3" 
                    placeholder='{"key": "value"}' ${isRequired ? 'required' : ''}></textarea>`;
            } else {
                // Text input for string and others
                inputHtml += `<input type="text" class="form-control" id="${key}" name="${key}" 
                    ${isRequired ? 'required' : ''} 
                    ${property.default !== undefined ? `value="${property.default}"` : ''}
                    placeholder="${property.description || key}">`;
            }
            
            formGroup.innerHTML = inputHtml;
            container.appendChild(formGroup);
        });
    } else {
        container.innerHTML = '<p class="text-muted">No input parameters required</p>';
    }
}

// Handle form submission
document.getElementById('toolExecuteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Collect form data
    const formData = new FormData(e.target);
    const arguments = {};
    
    for (const [key, value] of formData.entries()) {
        const property = toolSchema.properties[key];
        
        if (property) {
            if (property.type === 'integer') {
                arguments[key] = parseInt(value);
            } else if (property.type === 'number') {
                arguments[key] = parseFloat(value);
            } else if (property.type === 'boolean') {
                arguments[key] = document.getElementById(key).checked;
            } else if (property.type === 'object' && value) {
                try {
                    arguments[key] = JSON.parse(value);
                } catch (e) {
                    alert(`Invalid JSON for field ${key}`);
                    return;
                }
            } else if (value !== '') {
                arguments[key] = value;
            }
        }
    }
    
    // Show loading
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Executing...</p></div>';
    
    // Execute tool via API
    fetch('/api/tools/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getSessionToken()
        },
        body: JSON.stringify({
            tool: toolName,
            arguments: arguments
        })
    })
    .then(response => response.json())
    .then(data => {
        const timestamp = new Date().toLocaleString();
        
        if (data.success) {
            // Display success result
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> Execution Successful
                </div>
                <pre class="bg-light p-3">${JSON.stringify(data.result, null, 2)}</pre>
                <small class="text-muted">Executed at: ${timestamp}</small>
            `;
            
            // Add to history
            addToHistory(timestamp, 'success', arguments);
        } else {
            // Display error
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle-fill"></i> Execution Failed
                </div>
                <pre class="text-danger">${data.error}</pre>
                <small class="text-muted">Failed at: ${timestamp}</small>
            `;
            
            // Add to history
            addToHistory(timestamp, 'error', arguments);
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle-fill"></i> Network Error
            </div>
            <pre class="text-danger">${error.message}</pre>
        `;
    });
});

// Add execution to history
function addToHistory(timestamp, status, arguments) {
    executionHistory.unshift({
        timestamp: timestamp,
        status: status,
        arguments: arguments
    });
    
    // Keep only last 5
    executionHistory = executionHistory.slice(0, 5);
    
    // Update history display
    const historyDiv = document.getElementById('executionHistory');
    historyDiv.innerHTML = executionHistory.map((item, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between">
                <small>${item.timestamp}</small>
                <span class="badge bg-${item.status === 'success' ? 'success' : 'danger'}">
                    ${item.status}
                </span>
            </div>
            <small class="text-muted">
                Args: ${JSON.stringify(item.arguments).substring(0, 50)}...
            </small>
        </div>
    `).join('');
}

// Clear form
function clearForm() {
    document.getElementById('toolExecuteForm').reset();
    document.getElementById('results').innerHTML = `
        <div class="text-muted text-center">
            <i class="bi bi-info-circle"></i> Results will appear here after execution
        </div>
    `;
}

// Get session token (simplified - in production, handle this more securely)
function getSessionToken() {
    // This would typically get the token from session storage or cookie
    return '{{ session.token }}' || '';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    generateFormInputs();
});
</script>
{% endblock %}
