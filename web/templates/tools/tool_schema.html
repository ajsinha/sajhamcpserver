{% extends "common/base.html" %}
<!--
Copyright All rights Reserved 2025-2030, Ashutosh Sinha, Email: ajsinha@gmail.com
-->
{% block title %}{{ tool.name }} - Schema - SAJHA MCP Server{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-3">
        <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-speedometer2"></i> Back to Dashboard
        </a>
        <a href="{{ url_for('tools_list') }}" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-list"></i> Back to Tools
        </a>
    </div>

    <h1 class="h3 mb-4">
        <i class="bi bi-file-code"></i> Tool Schema: {{ tool.name }}
    </h1>

    <!-- Basic Information -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 150px;">Tool Name:</th>
                            <td><strong>{{ tool.name }}</strong></td>
                        </tr>
                        <tr>
                            <th>Version:</th>
                            <td>{{ tool.version }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if tool.enabled %}
                                    <span class="badge bg-success">Enabled</span>
                                {% else %}
                                    <span class="badge bg-danger">Disabled</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 150px;">Description:</th>
                            <td>{{ tool.description }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Schema -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-code-square"></i> Input Schema</h5>
        </div>
        <div class="card-body">
            {% if tool.inputSchema and tool.inputSchema.properties %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Parameter Name</th>
                                <th>Type</th>
                                <th>Required</th>
                                <th>Description</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prop_name, prop_details in tool.inputSchema.properties.items() %}
                            <tr>
                                <td><strong><code>{{ prop_name }}</code></strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ prop_details.type|upper }}</span>
                                </td>
                                <td>
                                    {% if tool.inputSchema.required and prop_name in tool.inputSchema.required %}
                                        <span class="badge bg-danger">REQUIRED</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Optional</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if prop_details.description %}
                                        {{ prop_details.description }}
                                    {% else %}
                                        <span class="text-muted">No description</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#details-{{ loop.index }}"
                                            aria-expanded="false">
                                        <i class="bi bi-chevron-down"></i> Details
                                    </button>
                                </td>
                            </tr>
                            <tr class="collapse" id="details-{{ loop.index }}">
                                <td colspan="5" class="bg-light">
                                    <div class="p-3">
                                        <h6>Additional Details for <code>{{ prop_name }}</code></h6>
                                        <ul class="mb-0">
                                            {% if prop_details.default is defined %}
                                                <li><strong>Default Value:</strong> <code>{{ prop_details.default }}</code></li>
                                            {% endif %}
                                            {% if prop_details.enum %}
                                                <li><strong>Allowed Values:</strong>
                                                    {% for val in prop_details.enum %}
                                                        <span class="badge bg-secondary">{{ val }}</span>
                                                    {% endfor %}
                                                </li>
                                            {% endif %}
                                            {% if prop_details.minimum is defined %}
                                                <li><strong>Minimum:</strong> {{ prop_details.minimum }}</li>
                                            {% endif %}
                                            {% if prop_details.maximum is defined %}
                                                <li><strong>Maximum:</strong> {{ prop_details.maximum }}</li>
                                            {% endif %}
                                            {% if prop_details.minLength is defined %}
                                                <li><strong>Minimum Length:</strong> {{ prop_details.minLength }}</li>
                                            {% endif %}
                                            {% if prop_details.maxLength is defined %}
                                                <li><strong>Maximum Length:</strong> {{ prop_details.maxLength }}</li>
                                            {% endif %}
                                            {% if prop_details.pattern %}
                                                <li><strong>Pattern:</strong> <code>{{ prop_details.pattern }}</code></li>
                                            {% endif %}
                                            {% if prop_details.items %}
                                                <li><strong>Array Items Type:</strong> {{ prop_details.items.type }}</li>
                                                {% if prop_details.items.description %}
                                                    <li><strong>Items Description:</strong> {{ prop_details.items.description }}</li>
                                                {% endif %}
                                            {% endif %}
                                            {% if prop_details.properties %}
                                                <li><strong>Object Properties:</strong> {{ prop_details.properties.keys()|list|join(', ') }}</li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> This tool does not require any input parameters.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- JSON Schema (Raw) -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-braces"></i> JSON Schema (Raw)</h5>
        </div>
        <div class="card-body">
            <pre class="border rounded p-3" style="background-color: #f8f9fa; color: #2c3e50; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace;"><code>{{ schema_json }}</code></pre>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyToClipboard('schema')">
                <i class="bi bi-clipboard"></i> Copy to Clipboard
            </button>
        </div>
    </div>

    <!-- JSON Configuration -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-file-earmark-code"></i> JSON Configuration (from config/tools)</h5>
        </div>
        <div class="card-body">
            {% if config_json %}
                <pre class="border rounded p-3" style="background-color: #f8f9fa; color: #2c3e50; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace;"><code>{{ config_json }}</code></pre>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyToClipboard('config')">
                    <i class="bi bi-clipboard"></i> Copy to Clipboard
                </button>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No configuration file found for this tool in config/tools folder.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Literature Content -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-book"></i> Literature Content</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="literatureContent" class="form-label">
                    Tool documentation, usage examples, and additional information:
                </label>
                <textarea class="form-control" id="literatureContent" rows="15"
                          style="font-family: 'Courier New', monospace; font-size: 0.9em;">{{ literature_content }}</textarea>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="saveLiterature()">
                    <i class="bi bi-save"></i> Save Literature
                </button>
                <button class="btn btn-outline-secondary" onclick="copyToClipboard('literature')">
                    <i class="bi bi-clipboard"></i> Copy to Clipboard
                </button>
            </div>
            <div id="literatureSaveStatus" class="mt-2"></div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
            <a href="{{ url_for('tool_execute', tool_name=tool.name) }}" class="btn btn-success">
                <i class="bi bi-play-circle"></i> Execute This Tool
            </a>
            <a href="{{ url_for('tools_list') }}" class="btn btn-outline-primary">
                <i class="bi bi-list"></i> View All Tools
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-speedometer2"></i> Back to Dashboard
            </a>
            {% if user and user.roles and 'admin' in user.roles %}
            <a href="{{ url_for('tool_config_page', tool_name=tool.name) }}" class="btn btn-outline-warning">
                <i class="bi bi-gear"></i> Edit Configuration
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyToClipboard(type) {
    let textToCopy;

    if (type === 'schema') {
        textToCopy = {{ schema_json|tojson }};
    } else if (type === 'config') {
        {% if config_json %}
        textToCopy = {{ config_json|tojson }};
        {% else %}
        alert('No configuration available to copy');
        return;
        {% endif %}
    } else if (type === 'literature') {
        textToCopy = document.getElementById('literatureContent').value;
    }

    navigator.clipboard.writeText(textToCopy).then(function() {
        let message;
        if (type === 'schema') {
            message = 'Schema';
        } else if (type === 'config') {
            message = 'Configuration';
        } else if (type === 'literature') {
            message = 'Literature content';
        }
        alert(message + ' copied to clipboard!');
    }, function() {
        alert('Failed to copy to clipboard');
    });
}

function saveLiterature() {
    const literatureContent = document.getElementById('literatureContent').value;
    const statusDiv = document.getElementById('literatureSaveStatus');
    const toolName = '{{ tool.name }}';

    // Show loading message
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Saving literature content...</div>';

    // Create form data
    const formData = new FormData();
    formData.append('literature_content', literatureContent);

    // Send POST request
    fetch(`/tools/${toolName}/literature/save`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> ' + data.message + '</div>';
            // Clear success message after 3 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ' + data.error + '</div>';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error saving literature: ' + error + '</div>';
    });
}
</script>
{% endblock %}