{% extends "base.html" %}
<!--
Copyright All rights Reserved 2025-2030, Ashutosh Sinha, Email: ajsinha@gmail.com
-->
{% block title %}User Configuration - {{ user_id }} - SAJHA MCP Server{% endblock %}

{% block extra_css %}
<!-- JSONEditor CSS -->
<link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.4/dist/jsoneditor.min.css" rel="stylesheet">
<style>
    .config-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }

    .json-editor-container {
        height: 600px;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }

    .save-status {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        max-width: 400px;
    }

    .user-info-card {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
    }

    .raw-json-view {
        display: none;
        background: #2d2d2d;
        color: #f8f8f2;
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        max-height: 600px;
        overflow: auto;
    }

    .form-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-section h5 {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #667eea;
    }

    .role-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.8rem;
        margin: 0.2rem;
        cursor: pointer;
    }

    .role-badge.selected {
        background-color: #667eea !important;
        color: white;
    }

    .tool-checkbox {
        margin: 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Save Status Alert -->
    <div id="saveStatus" class="save-status"></div>

    <!-- Header -->
    <div class="config-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-2">
                    <i class="bi bi-person-fill-gear"></i> User Configuration
                </h1>
                <h3 class="h5 mb-0 opacity-75">{{ user_id }}</h3>
            </div>
            <div>
                <a href="{{ url_for('admin_users') }}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Users
                </a>
            </div>
        </div>
    </div>

    <!-- User Information Display -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card user-info-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-info-circle-fill"></i> User Information
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>User ID:</strong> <span id="userIdDisplay">{{ user_id }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Status:</strong>
                            <span id="userStatusDisplay" class="badge bg-secondary">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Created:</strong> <span id="userCreatedDisplay">-</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Login:</strong> <span id="userLastLoginDisplay">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Configuration Forms -->
    <div class="row mb-4">
        <div class="col-md-6">
            <!-- Basic Information -->
            <div class="form-section">
                <h5><i class="bi bi-person"></i> Basic Information</h5>
                <div class="mb-3">
                    <label for="userName" class="form-label">Display Name *</label>
                    <input type="text" class="form-control" id="userName" placeholder="Enter display name">
                </div>
                <div class="mb-3">
                    <label for="userEmail" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="userEmail" placeholder="user@example.com">
                </div>
                <div class="mb-3">
                    <label for="userPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="userPassword" placeholder="Leave empty to keep current">
                    <small class="form-text text-muted">Only enter a value if you want to change the password</small>
                </div>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="userEnabled">
                        <label class="form-check-label" for="userEnabled">
                            Account Enabled
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Roles & Permissions -->
            <div class="form-section">
                <h5><i class="bi bi-shield-check"></i> Roles & Permissions</h5>
                <div class="mb-3">
                    <label class="form-label">User Roles</label>
                    <div id="rolesContainer">
                        <span class="badge bg-secondary role-badge" data-role="admin">
                            <i class="bi bi-star-fill"></i> Admin
                        </span>
                        <span class="badge bg-secondary role-badge" data-role="user">
                            <i class="bi bi-person"></i> User
                        </span>
                        <span class="badge bg-secondary role-badge" data-role="developer">
                            <i class="bi bi-code-slash"></i> Developer
                        </span>
                        <span class="badge bg-secondary role-badge" data-role="viewer">
                            <i class="bi bi-eye"></i> Viewer
                        </span>
                    </div>
                    <small class="form-text text-muted">Click to toggle roles</small>
                </div>
            </div>

            <!-- Tool Access -->
            <div class="form-section">
                <h5><i class="bi bi-tools"></i> Tool Access</h5>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="allToolsAccess" value="*">
                        <label class="form-check-label" for="allToolsAccess">
                            <strong>Grant Access to All Tools (*)</strong>
                        </label>
                    </div>
                </div>
                <div id="toolsContainer">
                    <small class="form-text text-muted">Loading available tools...</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced: JSON Editor -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-braces"></i> Advanced: JSON Configuration
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-light active" id="treeViewBtn">
                            <i class="bi bi-diagram-3"></i> Tree View
                        </button>
                        <button type="button" class="btn btn-sm btn-light" id="rawViewBtn">
                            <i class="bi bi-code-square"></i> Raw JSON
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- JSON Tree Editor -->
                    <div id="jsoneditor" class="json-editor-container"></div>

                    <!-- Raw JSON View -->
                    <pre id="rawJsonView" class="raw-json-view"><code id="rawJsonCode"></code></pre>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        <i class="bi bi-exclamation-triangle"></i>
                        Advanced users only. Changes here will override form values above.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="button" class="btn btn-primary btn-lg" id="saveUserBtn">
                                <i class="bi bi-save"></i> Save User Configuration
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" id="resetUserBtn">
                                <i class="bi bi-arrow-clockwise"></i> Reset Changes
                            </button>
                            <button type="button" class="btn btn-info" id="validateUserBtn">
                                <i class="bi bi-check-circle"></i> Validate
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-warning" id="downloadUserBtn">
                                <i class="bi bi-download"></i> Download JSON
                            </button>
                            {% if user_id != 'admin' %}
                            <button type="button" class="btn btn-danger" id="deleteUserBtn">
                                <i class="bi bi-trash"></i> Delete User
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Guide -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-book"></i> User Configuration Guide
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Required Fields:</h6>
                            <ul>
                                <li><strong>user_id:</strong> Unique identifier for login</li>
                                <li><strong>user_name:</strong> Display name</li>
                                <li><strong>password:</strong> User password (hashed)</li>
                                <li><strong>enabled:</strong> Account status (true/false)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Optional Fields:</h6>
                            <ul>
                                <li><strong>email:</strong> User email address</li>
                                <li><strong>roles:</strong> Array of user roles (admin, user, developer, viewer)</li>
                                <li><strong>tools:</strong> Array of accessible tool names or ["*"] for all</li>
                                <li><strong>created_at:</strong> Account creation timestamp</li>
                                <li><strong>last_login:</strong> Last login timestamp</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- JSONEditor JS -->
<script src="https://cdn.jsdelivr.net/npm/jsoneditor@9.10.4/dist/jsoneditor.min.js"></script>

<script>
const userId = "{{ user_id }}";
let editor = null;
let originalConfig = null;
let currentConfig = null;
let availableTools = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Initialize JSON Editor
    const container = document.getElementById('jsoneditor');
    const options = {
        mode: 'tree',
        modes: ['tree', 'code', 'form', 'text', 'view'],
        search: true,
        history: true,
        onChangeText: function(jsonString) {
            try {
                currentConfig = JSON.parse(jsonString);
            } catch(e) {
                console.error('Invalid JSON:', e);
            }
        }
    };

    editor = new JSONEditor(container, options);

    // Load user configuration
    loadUserConfig();

    // Load available tools
    loadAvailableTools();

    // Setup event listeners
    setupEventListeners();
});

function loadUserConfig() {
    showLoading();

    $.ajax({
        url: `/api/admin/users/${userId}/config`,
        method: 'GET',
        success: function(data) {
            originalConfig = JSON.parse(JSON.stringify(data));
            currentConfig = data;

            // Update form fields
            updateFormFields(data);

            // Set JSON editor content
            editor.set(data);

            // Update raw JSON view
            updateRawJsonView();

            hideLoading();
            showStatus('User configuration loaded successfully', 'success');
        },
        error: function(xhr, status, error) {
            hideLoading();
            showStatus('Failed to load user configuration: ' + error, 'danger');
        }
    });
}

function loadAvailableTools() {
    $.ajax({
        url: '/api/tools/list',
        method: 'GET',
        success: function(data) {
            availableTools = data.tools || [];
            renderToolsCheckboxes();
        },
        error: function() {
            $('#toolsContainer').html('<small class="text-danger">Failed to load tools</small>');
        }
    });
}

function renderToolsCheckboxes() {
    const container = $('#toolsContainer');
    container.empty();

    if (availableTools.length === 0) {
        container.html('<small class="text-muted">No tools available</small>');
        return;
    }

    availableTools.forEach(tool => {
        const checkbox = $(`
            <div class="form-check tool-checkbox">
                <input class="form-check-input tool-access-checkbox" type="checkbox"
                       value="${tool.name}" id="tool_${tool.name}">
                <label class="form-check-label" for="tool_${tool.name}">
                    ${tool.name}
                </label>
            </div>
        `);
        container.append(checkbox);
    });

    // Update checkboxes based on current config
    if (currentConfig && currentConfig.tools) {
        updateToolCheckboxes(currentConfig.tools);
    }
}

function updateToolCheckboxes(tools) {
    if (tools.includes('*')) {
        $('#allToolsAccess').prop('checked', true);
        $('.tool-access-checkbox').prop('disabled', true);
    } else {
        $('#allToolsAccess').prop('checked', false);
        $('.tool-access-checkbox').prop('disabled', false);
        tools.forEach(tool => {
            $(`#tool_${tool}`).prop('checked', true);
        });
    }
}

function updateFormFields(data) {
    // Basic info
    $('#userName').val(data.user_name || '');
    $('#userEmail').val(data.email || '');
    $('#userEnabled').prop('checked', data.enabled !== false);

    // Display info
    $('#userIdDisplay').text(data.user_id || userId);
    const statusBadge = data.enabled !== false ?
        '<span class="badge bg-success">Enabled</span>' :
        '<span class="badge bg-danger">Disabled</span>';
    $('#userStatusDisplay').html(statusBadge);
    $('#userCreatedDisplay').text(data.created_at ? new Date(data.created_at).toLocaleString() : 'N/A');
    $('#userLastLoginDisplay').text(data.last_login ? new Date(data.last_login).toLocaleString() : 'Never');

    // Roles
    const roles = data.roles || [];
    $('.role-badge').each(function() {
        const role = $(this).data('role');
        if (roles.includes(role)) {
            $(this).addClass('selected');
        } else {
            $(this).removeClass('selected');
        }
    });

    // Tools
    if (data.tools) {
        updateToolCheckboxes(data.tools);
    }
}

function getFormData() {
    const config = editor.get();

    // Update from form fields
    config.user_name = $('#userName').val();
    config.email = $('#userEmail').val();
    config.enabled = $('#userEnabled').prop('checked');

    // Update password if provided
    const newPassword = $('#userPassword').val();
    if (newPassword) {
        config.password = newPassword;
    }

    // Update roles
    config.roles = [];
    $('.role-badge.selected').each(function() {
        config.roles.push($(this).data('role'));
    });

    // Update tools
    if ($('#allToolsAccess').prop('checked')) {
        config.tools = ['*'];
    } else {
        config.tools = [];
        $('.tool-access-checkbox:checked').each(function() {
            config.tools.push($(this).val());
        });
    }

    return config;
}

function setupEventListeners() {
    // Save button
    $('#saveUserBtn').click(function() {
        saveUserConfig();
    });

    // Reset button
    $('#resetUserBtn').click(function() {
        if (confirm('Are you sure you want to reset all changes?')) {
            currentConfig = JSON.parse(JSON.stringify(originalConfig));
            updateFormFields(currentConfig);
            editor.set(currentConfig);
            updateRawJsonView();
            showStatus('Changes reset successfully', 'info');
        }
    });

    // Validate button
    $('#validateUserBtn').click(function() {
        validateUserConfig();
    });

    // Download button
    $('#downloadUserBtn').click(function() {
        downloadUserConfig();
    });

    // Delete button
    $('#deleteUserBtn').click(function() {
        deleteUser();
    });

    // View mode toggle
    $('#treeViewBtn').click(function() {
        switchToTreeView();
    });

    $('#rawViewBtn').click(function() {
        switchToRawView();
    });

    // Role badges toggle
    $('.role-badge').click(function() {
        $(this).toggleClass('selected');
    });

    // All tools checkbox
    $('#allToolsAccess').change(function() {
        const checked = $(this).prop('checked');
        $('.tool-access-checkbox').prop('disabled', checked);
        if (checked) {
            $('.tool-access-checkbox').prop('checked', false);
        }
    });
}

function switchToTreeView() {
    $('#jsoneditor').show();
    $('#rawJsonView').hide();
    $('#treeViewBtn').addClass('active');
    $('#rawViewBtn').removeClass('active');
}

function switchToRawView() {
    updateRawJsonView();
    $('#jsoneditor').hide();
    $('#rawJsonView').show();
    $('#treeViewBtn').removeClass('active');
    $('#rawViewBtn').addClass('active');
}

function updateRawJsonView() {
    try {
        const config = editor.get();
        const jsonString = JSON.stringify(config, null, 2);
        $('#rawJsonCode').text(jsonString);
    } catch(e) {
        $('#rawJsonCode').text('Invalid JSON');
    }
}

function saveUserConfig() {
    try {
        const config = getFormData();

        // Validate required fields
        if (!config.user_id || !config.user_name) {
            showStatus('User ID and Name are required', 'danger');
            return;
        }

        // Show loading
        showLoading();
        $('#saveUserBtn').prop('disabled', true);

        // Update editor with form data
        editor.set(config);

        // Save configuration
        $.ajax({
            url: `/api/admin/users/${userId}/config`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(config),
            success: function(response) {
                hideLoading();
                $('#saveUserBtn').prop('disabled', false);

                // Update original config
                originalConfig = JSON.parse(JSON.stringify(config));
                currentConfig = config;

                showStatus('User configuration saved successfully!', 'success');

                // Update display
                updateFormFields(config);
            },
            error: function(xhr, status, error) {
                hideLoading();
                $('#saveUserBtn').prop('disabled', false);

                let errorMsg = 'Failed to save user configuration';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                }
                showStatus(errorMsg, 'danger');
            }
        });

    } catch(e) {
        showStatus('Invalid configuration: ' + e.message, 'danger');
        $('#saveUserBtn').prop('disabled', false);
    }
}

function validateUserConfig() {
    try {
        const config = getFormData();
        const errors = [];

        if (!config.user_id) errors.push('Missing required field: user_id');
        if (!config.user_name) errors.push('Missing required field: user_name');
        if (!config.password && !originalConfig.password) errors.push('Password is required for new users');
        if (config.enabled === undefined) errors.push('Missing required field: enabled');

        if (!config.roles || config.roles.length === 0) {
            errors.push('At least one role must be assigned');
        }

        if (!config.tools || config.tools.length === 0) {
            errors.push('At least one tool access must be granted');
        }

        if (errors.length > 0) {
            showStatus('Validation failed:\n' + errors.join('\n'), 'danger');
        } else {
            showStatus('User configuration is valid!', 'success');
        }

    } catch(e) {
        showStatus('Invalid configuration: ' + e.message, 'danger');
    }
}

function downloadUserConfig() {
    try {
        const config = getFormData();
        const jsonString = JSON.stringify(config, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `user_${userId}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showStatus('User configuration downloaded', 'success');
    } catch(e) {
        showStatus('Failed to download: ' + e.message, 'danger');
    }
}

function deleteUser() {
    if (!confirm(`Are you sure you want to delete user "${userId}"? This action cannot be undone.`)) {
        return;
    }

    if (!confirm('This will permanently delete the user account. Are you absolutely sure?')) {
        return;
    }

    showLoading();

    $.ajax({
        url: `/api/admin/users/${userId}/delete`,
        method: 'DELETE',
        success: function(response) {
            hideLoading();
            showStatus('User deleted successfully. Redirecting...', 'success');
            setTimeout(function() {
                window.location.href = '/admin/users';
            }, 2000);
        },
        error: function(xhr, status, error) {
            hideLoading();
            let errorMsg = 'Failed to delete user';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg += ': ' + xhr.responseJSON.error;
            }
            showStatus(errorMsg, 'danger');
        }
    });
}

function showStatus(message, type) {
    const alertClass = `alert-${type}`;
    const iconClass = type === 'success' ? 'check-circle-fill' :
                     type === 'danger' ? 'exclamation-triangle-fill' :
                     'info-circle-fill';

    const alert = $(`
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="bi bi-${iconClass}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);

    $('#saveStatus').html(alert);

    setTimeout(function() {
        alert.fadeOut(500, function() {
            $(this).remove();
        });
    }, 5000);
}

function showLoading() {
    if (!$('#loadingOverlay').length) {
        $('body').append(`
            <div id="loadingOverlay" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            ">
                <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `);
    }
}

function hideLoading() {
    $('#loadingOverlay').remove();
}
</script>
{% endblock %}