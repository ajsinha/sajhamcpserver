{% extends "base.html" %}
<!--
Copyright All rights Reserved 2025-2030, Ashutosh Sinha, Email: ajsinha@gmail.com
-->
{% block title %}Prompts - SAJHA MCP Server{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item active">Prompts</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-chat-square-text"></i> Prompts Library
        </h1>
        {% if user and user.roles and 'admin' in user.roles %}
        <a href="{{ url_for('prompt_create_page') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Create New Prompt
        </a>
        {% endif %}
    </div>

    <!-- Filter Chips -->
    {% if active_category or active_tag %}
    <div class="mb-3">
        <strong>Active Filters:</strong>
        {% if active_category %}
        <span class="badge bg-primary me-2">
            Category: {{ active_category }}
            <a href="{{ url_for('prompts_list') }}" class="text-white ms-1">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
        {% if active_tag %}
        <span class="badge bg-info me-2">
            Tag: {{ active_tag }}
            <a href="{{ url_for('prompts_list') }}" class="text-white ms-1">
                <i class="bi bi-x"></i>
            </a>
        </span>
        {% endif %}
    </div>
    {% endif %}

    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-funnel"></i> Filters</h6>
                </div>
                <div class="card-body">
                    <!-- Categories -->
                    <h6 class="card-subtitle mb-2">Categories</h6>
                    <div class="list-group mb-3">
                        <a href="{{ url_for('prompts_list') }}" 
                           class="list-group-item list-group-item-action {% if not active_category %}active{% endif %}">
                            <i class="bi bi-grid"></i> All Categories
                            <span class="badge bg-secondary float-end">{{ prompts|length }}</span>
                        </a>
                        {% for category in categories %}
                        <a href="{{ url_for('prompts_by_category', category=category) }}" 
                           class="list-group-item list-group-item-action {% if active_category == category %}active{% endif %}">
                            <i class="bi bi-folder"></i> {{ category|title }}
                        </a>
                        {% endfor %}
                    </div>

                    <!-- Tags -->
                    <h6 class="card-subtitle mb-2">Tags</h6>
                    <div class="d-flex flex-wrap gap-1">
                        {% for tag in tags %}
                        <a href="{{ url_for('prompts_by_tag', tag=tag) }}" 
                           class="badge {% if active_tag == tag %}bg-primary{% else %}bg-secondary{% endif %} text-decoration-none">
                            #{{ tag }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i> 
                        {% if active_category %}
                        Prompts in "{{ active_category|title }}"
                        {% elif active_tag %}
                        Prompts tagged "{{ active_tag }}"
                        {% else %}
                        All Prompts
                        {% endif %}
                        <span class="badge bg-light text-dark ms-2">{{ prompts|length }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if prompts %}
                    <!-- Search and Controls -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="searchPrompts" 
                                       placeholder="Search prompts by name, description, or tags...">
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <select id="rowsPerPage" class="form-select">
                                <option value="6" selected>6 per page</option>
                                <option value="12">12 per page</option>
                                <option value="24">24 per page</option>
                                <option value="all">Show All</option>
                            </select>
                        </div>
                    </div>

                    <!-- Prompts Grid -->
                    <div class="row" id="promptsGrid">
                        {% for prompt in prompts %}
                        <div class="col-md-6 mb-3 prompt-item" 
                             data-name="{{ prompt.name }}" 
                             data-description="{{ prompt.description }}"
                             data-category="{{ prompt.category }}"
                             data-tags="{{ prompt.tags|join(',') }}">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <a href="{{ url_for('prompt_detail', prompt_name=prompt.name) }}" 
                                           class="text-decoration-none">
                                            {{ prompt.name }}
                                        </a>
                                    </h5>
                                    <h6 class="card-subtitle mb-2 text-muted">
                                        <span class="badge bg-secondary">{{ prompt.category }}</span>
                                    </h6>
                                    <p class="card-text">{{ prompt.description[:150] }}{% if prompt.description|length > 150 %}...{% endif %}</p>
                                    
                                    <!-- Tags -->
                                    <div class="mb-2">
                                        {% for tag in prompt.tags[:3] %}
                                        <span class="badge bg-info">{{ tag }}</span>
                                        {% endfor %}
                                        {% if prompt.tags|length > 3 %}
                                        <span class="badge bg-light text-dark">+{{ prompt.tags|length - 3 }} more</span>
                                        {% endif %}
                                    </div>

                                    <!-- Stats -->
                                    <small class="text-muted">
                                        <i class="bi bi-file-text"></i> {{ prompt.argument_count }} arguments
                                        {% if prompt.usage_count > 0 %}
                                        | <i class="bi bi-graph-up"></i> {{ prompt.usage_count }} uses
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="card-footer bg-white">
                                    <div class="btn-group w-100" role="group">
                                        <a href="{{ url_for('prompt_detail', prompt_name=prompt.name) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                        <a href="{{ url_for('prompt_test', prompt_name=prompt.name) }}" 
                                           class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-play-circle"></i> Test
                                        </a>
                                        {% if user and user.roles and 'admin' in user.roles %}
                                        <a href="{{ url_for('prompt_detail', prompt_name=prompt.name) }}#edit" 
                                           class="btn btn-sm btn-outline-warning">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div id="tableInfo" class="text-muted"></div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Prompts pagination">
                                <ul class="pagination justify-content-end mb-0" id="pagination"></ul>
                            </nav>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No prompts found
                        {% if active_category or active_tag %}
                        with the selected filters.
                        <a href="{{ url_for('prompts_list') }}" class="alert-link">Clear filters</a>
                        {% else %}
                        in the library.
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Store prompts data
const promptsData = [
    {% for prompt in prompts %}
    {
        name: "{{ prompt.name }}",
        description: "{{ prompt.description }}",
        category: "{{ prompt.category }}",
        tags: "{{ prompt.tags|join(',') }}",
        element: null
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

let currentPage = 1;
let rowsPerPage = 6;
let filteredData = [...promptsData];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Cache elements
    promptsData.forEach((prompt, index) => {
        const elements = document.querySelectorAll('.prompt-item');
        prompt.element = elements[index];
    });

    renderGrid();

    // Search functionality
    document.getElementById('searchPrompts').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        filteredData = promptsData.filter(prompt =>
            prompt.name.toLowerCase().includes(searchTerm) ||
            prompt.description.toLowerCase().includes(searchTerm) ||
            prompt.tags.toLowerCase().includes(searchTerm)
        );
        currentPage = 1;
        renderGrid();
    });

    // Rows per page
    document.getElementById('rowsPerPage').addEventListener('change', function(e) {
        rowsPerPage = e.target.value === 'all' ? filteredData.length : parseInt(e.target.value);
        currentPage = 1;
        renderGrid();
    });
});

function renderGrid() {
    const totalRows = filteredData.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage);

    if (currentPage > totalPages) {
        currentPage = totalPages || 1;
    }

    const start = (currentPage - 1) * rowsPerPage;
    const end = Math.min(start + rowsPerPage, totalRows);

    // Hide all items
    promptsData.forEach(prompt => {
        if (prompt.element) {
            prompt.element.style.display = 'none';
        }
    });

    // Show filtered items for current page
    filteredData.slice(start, end).forEach(prompt => {
        if (prompt.element) {
            prompt.element.style.display = 'block';
        }
    });

    // Update info
    if (totalRows > 0) {
        document.getElementById('tableInfo').textContent =
            `Showing ${start + 1} to ${end} of ${totalRows} prompts`;
    } else {
        document.getElementById('tableInfo').textContent = 'No prompts found';
    }

    // Render pagination
    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>`;
    pagination.appendChild(prevLi);

    // Pages
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);

    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }

    // Next
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderGrid();
        window.scrollTo(0, 0);
    }
}
</script>
{% endblock %}
